<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test NanoBanana Frontend Integration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #imageContainer { margin: 20px 0; }
        img { max-width: 300px; border: 1px solid #ccc; margin: 10px; }
    </style>
</head>
<body>
    <h1>Test NanoBanana Frontend Integration</h1>
    
    <button onclick="testSessionCreation()">1. Test Session Creation</button>
    <button onclick="testImageGeneration()">2. Test Image Generation</button>
    <button onclick="testHistoryRetrieval()">3. Test History Retrieval</button>
    <button onclick="runFullTest()">Run Full Test</button>
    
    <div id="logs"></div>
    <div id="imageContainer"></div>
    
    <script>
        const backendUrl = 'http://localhost:8001';
        let currentSessionId = null;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(message);
        }
        
        async function testSessionCreation() {
            log('Testing session creation...');
            try {
                const response = await fetch(`${backendUrl}/api/nanobanana/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const session = await response.json();
                currentSessionId = session.id;
                log(`✅ Session created successfully: ${session.id}`, 'success');
                return session;
            } catch (error) {
                log(`❌ Session creation failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function testImageGeneration() {
            if (!currentSessionId) {
                log('❌ No session ID available. Create a session first.', 'error');
                return;
            }
            
            log('Testing image generation...');
            try {
                const response = await fetch(`${backendUrl}/api/nanobanana/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        prompt: 'Un chat orange mignon'
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`✅ Image generation successful: ${result.response_text}`, 'success');
                return result;
            } catch (error) {
                log(`❌ Image generation failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function testHistoryRetrieval() {
            if (!currentSessionId) {
                log('❌ No session ID available. Create a session first.', 'error');
                return;
            }
            
            log('Testing history retrieval...');
            try {
                const response = await fetch(`${backendUrl}/api/nanobanana/session/${currentSessionId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const history = await response.json();
                log(`✅ History retrieved successfully: ${history.length} messages`, 'success');
                
                // Display images if any
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = '';
                
                history.forEach((message, index) => {
                    if (message.image_urls && message.image_urls.length > 0) {
                        message.image_urls.forEach((imageUrl, imgIndex) => {
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = `Generated image ${imgIndex + 1}`;
                            img.onload = () => log(`✅ Image ${imgIndex + 1} loaded successfully`, 'success');
                            img.onerror = () => log(`❌ Failed to load image ${imgIndex + 1}`, 'error');
                            imageContainer.appendChild(img);
                        });
                    }
                });
                
                return history;
            } catch (error) {
                log(`❌ History retrieval failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function runFullTest() {
            log('=== Starting Full Test ===');
            try {
                await testSessionCreation();
                await testImageGeneration();
                await testHistoryRetrieval();
                log('=== Full Test Completed Successfully ===', 'success');
            } catch (error) {
                log('=== Full Test Failed ===', 'error');
            }
        }
    </script>
</body>
</html>